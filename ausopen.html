<!DOCTYPE html>
<html>
  <head> 
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        .bar {
          fill: steelblue;
        }
    
        .bar:hover {
          fill: brown;
        }
    </style>
  </head>
  <body>
    <p>Hello!</p>
    <!-- <div id="chart"></div> -->
    <svg width="960" height="500"></svg>
    <script>
        let data;
        d3.csv("data/10yearAUSOpenMatches.csv", function(d) {
            return {
                round: d.round,
                roundNo: getRoundNo(d.round),
                winner: d.winner,
                results: d.results,
                year: +d.year,
                player1: d.player1,
                player2: d.player2,
                country1: d.country1,
                country2: d.country2,
                firstServe1: +d.firstServe1.substring(0, d.firstServe1.length - 1),
                firstServe2: +d.firstServe2.substring(0, d.firstServe2.length - 1),
                ace1: +d.ace1,
                ace2: +d.ace2,
                double1: +d.double1,
                double2: +d.double2,
                firstPointWon1: +d.firstPointWon1.substring(0, d.firstPointWon1.length - 1),
                firstPointWon2: +d.firstPointWon2.substring(0, d.firstPointWon2.length - 1),
                secPointWon1: +d.secPointWon1.substring(0, d.secPointWon1.length - 1),
                secPointWon2: +d.secPointWon2.substring(0, d.secPointWon2.length - 1),
                fastServe1: +d.fastServe1,
                fastServe2: +d.fastServe2,
                avgFirstServe1: +d.avgFirstServe1,
                avgFirstServe2: +d.avgFirstServe2,
                avgSecServe1: +d.avgSecServe1,
                avgSecServe2: +d.avgSecServe2,
                break1: +d.break1.substring(0, d.break1.length - 1),
                break2: +d.break2.substring(0, d.break2.length - 1),
                return1: +d.return1.substring(0, d.return1.length - 1),
                return2: +d.return2.substring(0, d.return2.length - 1),
                total1: +d.total1,
                total2: +d.total2,
                winner1: +d.winner1,
                winner2: +d.winner2,
                error1: +d.error1,
                error2: +d.error2,
                net1: +d.net1.substring(0, d.net1.length - 1),
                net2: +d.net2.substring(0, d.net2.length - 1),
            };
        }).then(function(d) {
            data = d;
            // console.log(data[0]);
            barChart();
        });

        function getRoundNo(round) {
            return round == 'First' ? 1 :
                    round == 'Second' ? 2 :
                    round == 'Third' ? 3 :
                    round == 'Fourth' ? 4 :
                    round == 'quarter' ? 5 :
                    round == 'semi' ? 6 : 7
        }

        function barChart() {
            // console.log(data[0])
            let most_wins = d3.nest()
                            .key(function (d) {return d.winner })
                            .rollup(function (d) { return d.length })
                            .entries(data);
            
            let sorted_data = most_wins.sort(function (d1, d2) {
                return d2.value - d1.value
            });

            let sliced_data = sorted_data.slice(0, 10);
            // console.log(sliced_data)
                    
            var svg = d3.select("svg"),
            margin = {
                top: 20,
                right: 20,
                bottom: 30,
                left: 50
            },
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1);

            var y = d3.scaleLinear()
                .rangeRound([height, 0]);

            x.domain(sliced_data.map(function (d) {
                return d.key;
            }));
            y.domain([0, d3.max(sliced_data, function (d) {
                return d.value;
            })]);

            g.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x))

            g.append("g")
            .call(d3.axisLeft(y))
            .append("text")
            .attr("fill", "#000")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end")
            .text("Wins");

            g.selectAll(".bar")
            .data(sliced_data)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", function (d) {
                return x(d.key);
            })
            .attr("y", function (d) {
                return y(d.value);
            })
            .attr("width", x.bandwidth())
            .attr("height", function (d) {
                return height - y(d.value);
            });

            svg.selectAll(".bar").on('click', function(d, i) {
                test(d)
            });

        }

        function test(data_pa) {
            // console.log(data_pa)
            
            let user_data = data.filter(function (d) {
                if (d.winner == data_pa.key) {
                    return d
                }
            })

            let user_data_2 = d3.nest()
                .key(function(d) { return d.year; })
                .rollup(function (d) { return d.length })
                .entries(user_data)

            user_data_2 = user_data_2.sort(function (d1, d2) {
                return d2.key - d1.key
            });

            // console.log(user_data_2)

            d3.select("svg").html("");
            
            var margin = {top: 20, right: 20, bottom: 30, left: 40},
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            // set the ranges
            var y = d3.scaleBand()
                    .range([height, 0])
                    .padding(0.1);

            var x = d3.scaleLinear()
                    .range([0, width]);
                    
            // append the svg object to the body of the page
            // append a 'group' element to 'svg'
            // moves the 'group' element to the top left margin
            var svg = d3.select("svg")//.append("svg")
                .attr("width", width + margin.left + margin.right + 100)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform", 
                    "translate(" + margin.left + "," + margin.top + ")");

            // Scale the range of the data in the domains
            x.domain([0, d3.max(user_data_2, function(d){ return d.value; })])
            y.domain(user_data_2.map(function(d) { return d.key; }));

            // append the rectangles for the bar chart
            var bars = svg.selectAll(".bar")
                .data(user_data_2)
                .enter().append("g")
            
            bars.append("rect")
                .attr("class", "bar")
                .attr("width", function(d) {return x(d.value); } )
                .attr("y", function(d) { return y(d.key); })
                .attr("height", y.bandwidth());

            bars
                .data(user_data_2)
                .enter()
                .append("text")

            bars
                // .data(user_data_2)
                // .enter()
                .append("text")        
                .attr("y", function(d) {
                    return y(d.key) + y.bandwidth() / 2;
                })
                .attr("x", 10)
                .text(function(d) {
                    // return d.value
                    return d.value == 1 ? "First" :
                        d.value == 2 ? "Second" :
                        d.value == 3 ? "Third" :
                        d.value == 4 ? "Fourth" :
                        d.value == 5 ? "Quarter Final" :
                        d.value == 6 ? "Runner up" : "Winner!"
                        
                })
                .attr("x", function(d) {
                    return x(d.value) + 10;
                });
        
            

            // add the x Axis
            // svg.append("g")
            //     .attr("transform", "translate(0," + height + ")")
            //     .call(d3.axisBottom(x));

            // add the y Axis
            svg.append("g")
                .call(d3.axisLeft(y));

        }

    </script>
  </body>
</html>
